<!DOCTYPE html>
<html>
<head>
    <title>Database</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='res/core.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='themes/' ~ theme ~ '.css') }}">
    <script src="{{ url_for('static', filename='res/core.js') }}"></script>
    <style>
        .modal-body label {
            display: block;
            margin-bottom: 5px;
            color: var(--p-text-muted);
        }
        .modal-body input, .modal-body textarea {
            width: 100%;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="grid" style="align-items: center; padding: 10px;">
        <h1>DataBase</h1>
        <search>
            <form action="{{ url_for('database') }}" method="get" class="flex" style="align-items: center; gap: 10px;">
                <input type="text" name="cari" placeholder="Cari..." style="width: 250px;" value="{{ request.args.get('cari', '') }}">
                <button type="submit" class="btn btn-primary">Cari</button>
            </form>
        </search>
    </div>
    <div class="page-container">
        <div class="grid">
            <div class="card">
                Total File : {{ datasets|length }}
            </div>
            <div class="card">
                Total : {{ current_count }} / {{ limit_count }}
            </div>
            <div class="card" style="display: flex; align-items: center; gap: 10px;">
                <span>Storage: {{ storage_percent }}%</span>
                {% if storage_percent >= 99 %}
                    <span class="badge badge-error">Storage is full</span>
                {% elif storage_percent >= 90 %}
                    <span class="badge badge-warning">Storage Almost Full</span>
                {% endif %}
            </div>
        </div>
        <div class="grid">
            <div class="flex" style="gap: 10px;">
                <button onclick="openModal('uploadModal')" class="btn btn-primary">Add</button>
                <button onclick="openModal('deleteAllModal')" class="btn btn-danger">Delete All</button>
            </div>
        </div>
        <table class="data-table">
            <thead>
                <tr class="card">
                    <th style="text-align: center;">Name</th>
                    <th style="text-align: center;">Note</th>
                    <th style="text-align: center;">Type</th>
                    <th style="text-align: center;">Size</th>
                    <th style="text-align: center;">Uploaded</th>
                    <th style="text-align: center;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in datasets %}
                <tr class="card">
                    <td>
                        <div style="max-width: 200px; overflow-x: auto; white-space: nowrap; font-weight: 500;">
                            {{ item.name }}
                        </div>
                    </td>
                    <td>
                        <div style="max-height: 100px; max-width: 400px; overflow-y: auto;">
                            {{ item.note }}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 50px; text-transform: uppercase;">
                            {{ item.type|replace('.', '') }}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 50px;">
                            {{ item.size }}
                        </div>
                    </td>
                    <td>
                        <div style="min-width: 100px;">
                            {{ item.uploaded_at }}
                        </div>
                    </td>
                    <td>
                        <div class="flex" style="gap: 5px;">
                            {% if not item.is_public %}
                            <button class="btn btn-primary"
                                onclick="openEditModal(this)"
                                data-id="{{ item.data_id }}"
                                data-name="{{ item.name }}"
                                data-note="{{ item.note }}">
                                Edit
                            </button>
                            <form action="{{ url_for('delete_data', data_id=item.data_id) }}" method="post" style="display: inline;">
                                <button type="submit" class="btn btn-primary" onclick="return confirm('Delete data?')">Delete</button>
                            </form>
                            {% else %}
                            <span class="badge badge-info">Public</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="uploadModal" class="modal-wrapper">
        <div class="modal-content" style="max-width: 500px; height: auto;">
            <div class="modal-header">
                <h3>Upload File</h3>
            </div>
            <form action="{{ url_for('add_data') }}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <label>File (.csv)</label>
                    <input type="file" name="file" accept=".csv" required>

                    <label>Note</label>
                    <textarea name="note" style="height: 100px; resize: vertical;"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('uploadModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
    <div id="deleteAllModal" class="modal-wrapper">
        <div class="modal-content" style="max-width: 400px; height: auto;">
            <div class="modal-header">
                <h3>Warning</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete ALL your private files? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteAllModal')">Cancel</button>
                <form action="{{ url_for('delete_all_data') }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger">Continue</button>
                </form>
            </div>
        </div>
    </div>
    <div id="notificationModal" class="modal-wrapper {% if request.args.get('notify_title') %}show{% endif %}">
        <div class="modal-content" style="max-width: 400px; height: auto;">
            <div class="modal-header">
                <h3>{{ request.args.get('notify_title', 'Notification') }}</h3>
            </div>
            <div class="modal-body">
                <p>{{ request.args.get('notify_msg', '') }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeModal('notificationModal')">OK</button>
            </div>
        </div>
    </div>
    
    <div id="editModal" class="modal-wrapper">
        <div class="modal-content" style="max-width: 500px; height: auto;">
            <div class="modal-header">
                <h3>Edit File</h3>
            </div>
            <form id="editForm" action="" method="post">
                <div class="modal-body">
                    <label>File Name</label>
                    <input type="text" name="name" id="editName" required maxlength="80">

                    <label>Note</label>
                    <textarea name="note" id="editNote" style="height: 100px; resize: vertical;"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function openEditModal(btn) {
            const id = btn.getAttribute('data-id');
            let name = btn.getAttribute('data-name');
            const note = btn.getAttribute('data-note');

            if (name.toLowerCase().endsWith('.csv')) {
                name = name.slice(0, -4);
            }

            document.getElementById('editName').value = name;
            document.getElementById('editNote').value = note;
            document.getElementById('editForm').action = "/API/db/edit_data/" + id;

            openModal('editModal');
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal-wrapper')) {
                event.target.classList.remove('show');
            }
        }
    </script>
</body>

</html>